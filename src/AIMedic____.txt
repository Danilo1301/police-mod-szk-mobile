#include "AIMedic.h"

#include "CleoFunctions.h"
#include "Criminals.h"
#include "Peds.h"
#include "Vehicles.h"
#include "ScriptTask.h"
#include "BottomMessage.h"

AIMedic::~AIMedic()
{

}

void AIMedic::Start()
{
    fileLog->Log("AIMedic: Start");
    menuDebug->AddLine("AIMedic started");
    
    g_onPedLeaveVehicle->Add([this](int pedRef) {
        if(pedRef == this->pedRef) DoAction();
    });
    
    auto medic = Peds::GetPed(pedRef);
    medic->LeaveCar();
} 

void AIMedic::Update()
{
    if(!ACTOR_DEFINED(pedRef)) return;
}

void AIMedic::FindTarget()
{
    fileLog->Log("AIMedic: FindTarget");

    targetPed = -1;

    auto medic = Peds::GetPed(pedRef);

    CVector medicPos = medic->GetPosition(); // posição do médico
    float closestDist = 30.0f;                // limite máximo
    int closestPed = -1;

    auto peds = Peds::GetPedsMap();
    for (auto& pair : peds)
    {
        auto ped = pair.second;

        // Ignorar ped inválido
        if (!ped || ped->ref < 0)
            continue;

        // Tem que estar inconsciente
        if (!ped->flags.isInconcious)
            continue;

        // Ignorar peds que já estão sendo tratados
        if (ped->flags.isBeingTreated) 
            continue;

        // Distância
        CVector pos = ped->GetPosition();
        float dist = distanceBetweenPoints(medicPos, pos);

        // É o mais próximo encontrado?
        if (dist < closestDist)
        {
            closestDist = dist;
            closestPed = ped->ref;
        }
    }

    targetPed = closestPed;
}

void AIMedic::DoAction()
{
    menuDebug->AddLine("AIMedic: DoAction");

    FindTarget();

    auto medic = Peds::GetPed(pedRef);

    if(!medic->IsInAnyCar())
    {
        if (targetPed != -1)
        {
            
            auto deadPed = Peds::GetPed(targetPed);

            deadPed->flags.isBeingTreated = true;

            ScriptTask* taskAproach = new ScriptTask("aproach");
            taskAproach->SetStartAgainIfTimeout(2000);
            taskAproach->onBegin = [medic, deadPed]() {

                BottomMessage::SetMessage("make it aproach", 1000);
                CLEAR_ACTOR_TASK(medic->ref);
                TASK_FOLLOW_FOOTSTEPS(medic->ref, deadPed->ref);
            };
            taskAproach->onExecute = [medic, deadPed]() {        
                if(!Peds::IsValid(medic)) return SCRIPT_CANCEL;
                if(!Peds::IsValid(deadPed)) return SCRIPT_CANCEL;

                auto distance = distanceBetweenPoints(medic->GetPosition(), deadPed->GetPosition());
                if(distance < 1.0f) return SCRIPT_SUCCESS;

                return SCRIPT_KEEP_GOING;
            };
            taskAproach->onCancel = []() {

            };
            taskAproach->onComplete = [this, deadPed]() {
                RessurectPed(deadPed);
            };
            taskAproach->Start();
        } else {

            auto medic = Peds::GetPed(pedRef);
            auto vehicle = Vehicles::GetVehicle(medic->previousVehicle);

            vehicle->ValidateOwners();
            medic->EnterPreviousVehicle();

            if(medic->prevSeatId == 0)
            {
                BottomMessage::SetMessage("Esperar todos entrarem...", 3000);
            }
        }
    }
}

void AIMedic::RessurectPed(Ped* deadPed)
{
    auto medic = Peds::GetPed(pedRef);

    PERFORM_ANIMATION_AS_ACTOR(medic->ref, "CPR", "MEDIC", 8.0f, 0, 0, 0, 0, -1);

    WAIT(6000, [deadPed] () {
        deadPed->Reanimate();
    });

    WAIT(6000 + 500, [this] () {
        DoAction();
    });
}